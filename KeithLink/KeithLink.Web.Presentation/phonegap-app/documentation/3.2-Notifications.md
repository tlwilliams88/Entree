# Push Notifications

## PhonegapPushService

Devices are registered to receive push notifications in the PhonegapPushService located in ```phonegap-app/BEKPhoneGap/www/scripts/phonegapServices/PhonegapPushService.js```.

The ```registeredDevice``` function is called and sends the device data to the backend using the following format.
 
```json
{
    deviceos: 1, // 1 for iOS, 2 for Android
    deviceid: "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",
    providertoken: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX..."
}
```

This calls the /messaging/registerpushdevice endpoint which creates a database entry that associates the logged in user to that device and it registers the device with Amazon SNS. The ```providertoken``` corresponds to the token in Amazon SNS.

## Amazon SNS

### Sending a Test Notification

1. Go to the [Amazon SNS Console](https://951996173818.signin.aws.amazon.com/console)
2. Click Applications
3. Select your application, iOS or Android, QA or Prod
4. You will see a list of "Endpoints". These are registered devices.
5. Find your device token. You can get this by running the app locally on your device and putting a breakpoint in the PhonegapPushService.
6. Select your endpoint and click "Publish to endpoint"
7. Create the message
    - For iOS, use the Raw message format to send a message
    - For Android, use JSON format and use the JSON Message Generator

## iOS

### Finding the push notification cert

The Amazon SNS APNS Application is tied to the iOS app through an SSL Cert. This can be found using the following steps:

1. Go to the [Member Center](developer.apple.com/membercenter)
2. Click on Certificates, Identifiers & Profiles
3. Click Identifiers
4. Select the Prod Entree Ben E Keith app
5. Click Edit
6. Scroll down to Push Notifications
7. You will see where you can Revoke, Download, or Create a new Certificate

### Creating a new cert

1. Follow the steps above for "Finding the push notification cert" and create a new Production SSL Certificate
2. Follow the on-screen steps which are as follows
    1. Open Keychain Access
    2. Select Keychain Access >  Certificate Assistant > Request a Certificate from a Certificate Authority
    3. In the "Request is" group, select the "Saved to disk" option.
    4. Click Continue and it will save the CSR
3. Upload this CSR file and it will generate the new cert you can download

### Adding the Cert to Amazon SNS

[Amazon SNS Documentation](http://docs.aws.amazon.com/sns/latest/dg/mobile-push-apns.html)

1. Download the Cert from the [Member Center](developer.apple.com/membercenter) following the steps above
2. Convert the .cer format to .pem format changing the name of the .cer file to match your downloaded cert
`openssl x509 -in myapnsappcert.cer -inform DER -out myapnsappcert.pem`
3. Double-click the .cer file to open it in Keychain Access
4. In Keychain Access, select Certificates
5. Find the Apple Production iOS Push Services: com.benekeith.entreeprod cert and expand the arrow on the left to reveal a key
6. Highlight this key and select File > Export Items...
7. Leave the default .p12 format and save the file. You will be prompted to create a password. You will need this password for the next step
8. Convert the .p12 format to .pem format
`openssl pkcs12 -in myapnsappprivatekey.p12 -out myapnsappprivatekey.pem -nodes -clcerts`
9. You should now have both the cert and key in .pem format. You can test them with this command.
`openssl s_client -connect gateway.sandbox.push.apple.com:2195 -cert myapnsappcert.pem -key myapnsappprivatekey.pem`
10. Go to [Amazon SNS](https://951996173818.signin.aws.amazon.com/console)
3. Click Applications
4. Click the checkbox for the BEK_APNS
4. Click Actions -> Update Credentials

## Android Notifications

### Sender ID 

The app needs a sender ID to enable Google Cloud Messaging (GCN). This correspondes to the Project Number of the Google Developer Project. 

#### Finding the Sender Id in the Google Developer Console

1. Go to the [Google Developer Console](http://console.developers.google.com)
2. Make sure the Ben E Keith Entree Prod project is selected
3. On the Overview page, you should see the Project Number. This is the Sender ID.

#### Changing the Sender ID in the Google Play Developer Console

1. Go to the [Google Play Developer Console](https://play.google.com/apps/publish/)
2. Go to Services & APIs
3. You can see the Sender ID in the Linked Sender IDs section

#### Changing the Sender ID in the code

1. PhonegapPushService
2. Register function
3. Look for the line like... ```"senderID":"XXXXXXXX"```

### API Key

#### Finding the API Key for Push Notifications

1. Go to the [Google Developer Console](http://console.developers.google.com)
2. Make sure the Ben E Keith Entree Prod project is selected
3. Click APIs & auth
4. Click Credentials
5. You should see the API Key on this page

### Adding the API Key to Amazon SNS

1. Go to [Amazon SNS](https://951996173818.signin.aws.amazon.com/console)
2. Click Applications
3. Click the checkbox for the BEK_GCM
4. Click Actions -> Update Credentials
5. You can enter the api key here
