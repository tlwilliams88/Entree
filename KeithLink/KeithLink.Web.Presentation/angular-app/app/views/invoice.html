<div page-header-bar>
  <div header-message>
    Showing
    <div class="btn-group hidden-print" dropdown is-open="status.isopen1">
      <button type="button" class="btn-lg btn btn-default dropdown-toggle">{{selectedFilterView.name}} <span class="caret text-dark"></span></button>

      <ul class="dropdown-menu">
        <li><a
          ng-repeat="filterView in filterViews"
          ng-click="selectFilterView(filterView)"
          ng-if="selectedFilterView.name !== filterView.name">
        {{filterView.name}}</a></li>
      </ul>
    </div>
  </div>
  <div header-buttons>
    <button 
      type="button" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices && !isInternalUser" 
      class="btn btn-primary btn-lg pay-btn" 
      analytics-on 
      analytics-category="Invoices" 
      analytics-event="Pay Invoice"
      ng-show="hasPayableInvoices">
      <span ng-if="selectedFilterView.name !== 'Invoices Pending Payment'" >Pay Now</span>
      <span ng-if="selectedFilterView.name === 'Invoices Pending Payment'" >Update Payment(s)</span>
    </button>
    <a class="btn btn-icon btn-default" ng-click="print()" title="Print"><span class="icon-printer"></span></a>
    <a class="btn btn-icon btn-default" ng-click="openExportModal()" title="Export"><span class="icon-export"></span></a>
  </div>
</div>

<form name="invoiceForm"
      unsaved-warning-form 
      class="style-validation-errors" 
      novalidate>
  <div class="row page-content" style="margin-top:5px;">
    <div  class = "billing" ng-if="(!isInternalAccountAdminUser || isDemo)">
      <div class="no-open-invoices" style="margin-left:15px;" ng-if="!hasPayableInvoices && !loadingResults">
        <p>You have no payable invoices at this time.</p>
        <p>Contact your DSR to pay invoices online.</p>
      </div>
      <div style=" width:100%; display:inline-block;">
        <div class="pull-left billing-info" ng-if="hasPayableInvoices"></div>
      </div> 
    </div>
    <div class="col-sm-10" >
      <span class="pull-left"></span>
      <div class="text-red invoice-error">{{errorMessage}}</div>
    </div>

    <div style="max-width:100%; padding:0 50px 0 50px">
      <div class="row">
        <div class="col-sm-12 col-xs-8">
          <div ng-if="invoiceCustomers.length" class="pull-left credit-memo-toggle"><input type="checkbox" ng-click="filterInvoices(invoiceFilter = !invoiceFilter)" > Invoices with Credit Memos</div> 
          <div ng-if="!noInvoices && !isInternalUser" class="pull-left credit-memo-toggle" style="margin-left:15px;">
            <input type="checkbox" class="invoiceSelectAll" ng-model="invoiceCustomers.allSelected" ng-click="selectAll(areAllSelected = !areAllSelected, 'selectAllInvoices')"> Select All Invoices
          </div>
          <div ng-if="!noInvoices && !isInternalUser" class="pull-right">
            <a style="margin-right:10px;" class="expandcollapsecustomers">Expand/Collapse All Customers</a>
            <span class="total-amt total-line text-green currency-value">Total: {{totalPaymentAmount() | currency}}</span>
          </div>
        </div>
      </div>

      <div ng-if="!noInvoices" class="row topPadded">
        <div class="col-sm-12">
          <accordion close-others="oneAtATime">
            <accordion-group is-open="status.openCategories" class="panel-title" ng-show="true" ng-repeat="customer in invoiceCustomers | filter: {invoices: '!!'} | orderBy:'name'">
              <accordion-heading>
                <input type="checkbox" ng-if="!isInternalAccountAdminUser && customer.ispayable && selectedFilterView.name !== 'Paid Invoices'" ng-click="selectAll(areAllSelected = !areAllSelected, selectCustomerInvoices, customer, $event)" ng-checked="customer.selected" class="pull-left"/>
                <div class="white-space: normal;">
                  <span style="padding-left:10px;"> {{customer.number}} - {{customer.name}} ({{customer.invoices.length}})</span>
                  <span style="margin-left:20px;"> {{customer.street}} {{customer.city}}, {{customer.state}} {{customer.zipcode}}</span>
                  <i class="pull-right" ng-class="{'icon-arrow-up6': status.openCategories, 'icon-arrow-down7': !status.openCategories}"></i>
                </div>
              </accordion-heading>
              <div ng-repeat="invoice in customer.invoices" class="panel panel-body panel-default">
                <div>
                  <div>
                    <label>
                      <input type="checkbox" style="margin-left:10px;" no-dirty-check ng-if="invoice.userCanPayInvoice && !isInternalAccountAdminUser" ng-model="invoice.isSelected" ng-change="selectInvoice(invoice, invoice.isSelected)">
                    </label>
                  </div>
                  <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                    <span></span><a ng-click="linkToReferenceNumber(invoice.customernumber, invoice.branchid, invoice.invoicenumber)"><strong><span style="text-decoration:none" class="text-black" > Reference#:</span> {{invoice.invoicenumber}}</a></strong>
                    <h5 >Type: {{invoice.typedescription}}</h5>
                    <h5 class="highlight-text" >Status: {{invoice.statusdescription}}</h5>
                  </div>
                  <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                    <h5 >PONumber: {{invoice.ponumber}}</h5>
                    <h5 >Invoice Date: {{invoice.invoicedate |formatDate}}</h5>
                    <h5 >Due Date: {{invoice.duedate | formatDate}}</h5>
                  </div>
                  <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                    <h5 >Invoice Amount: {{invoice.invoiceamount | currency}}</h5>
                    <h5>Amount Due: {{invoice.amount | currency}}<span><a class="icon-plus3 large-icon" style="margin-left:5px;" ng-if="invoice.transactioncount > 2" tooltip="View transaction history for this invoice."  ng-click="openTransactionSummaryModal(invoice)"></a></span></h5>
                    <h5>Invoice Image: <span><a ui-sref="invoiceimage({ invoiceNumber: invoice.invoicenumber })" target="_blank" class="icon-camera large-icon" analytics-on analytics-category="Invoices" analytics-event="View Invoice Image"></a></span></h5>
                  </div>
                  <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                    Scheduled Date: 
                    <a 
                      ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}" 
                      ng-if="invoice.userCanPayInvoice && !invoice.showDatePicker && !isInternalAccountAdminUser"
                      ng-mouseenter="invoice.showDatePicker=true"
                      class="icon-calendar large-icon text-right">
                    </a>
                    <a
                      id="datePickerWithOptions"
                      ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}"
                      ng-click="openDatepicker = true"
                      ng-if="invoice.userCanPayInvoice && invoice.showDatePicker && !isInternalAccountAdminUser"
                      class="icon-calendar large-icon text-right"                
                      datepicker-popup="{{datepickerOptions.options.dateFormat}}"
                      ng-model="invoice.date"
                      is-open="openDatepicker"
                      ng-change="toggleSelect(invoice, 'date'); validateBatch()"
                      min-date="datepickerOptions.minDate"
                      max-date="invoice.maxPaymentDate"
                      datepicker-options="datepickerOptions.options"
                      date-disabled="disabled(date, mode)"
                      close-text="Close">
                    </a>
                    <span class="date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription !== 'Past Due' && invoice.statusdescription !== 'Payment Pending' && invoice.date">{{invoice.date | formatDate}}</span>
                    <span class="date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription === 'Past Due'">{{invoice.date || tomorrow | formatDate}}</span>
                    <span class="date-picker-field" ng-if="invoice.statusdescription === 'Payment Pending'">{{invoice.date || invoice.pendingtransaction.date | formatDate}}</span>
                    <h5>Payment Amount: {{invoice.pendingtransaction.amount}} <span class="input-col">
                      <input
                      remove-positive-numbers
                      ng-disabled="isInternalAccountAdminUser"
                      name="paymentAmount"
                      id="paymentAmount"
                      status = '{{invoice.statusdescription}}'
                      invoice-amount = "invoice.amount"
                      ng-if="invoice.userCanPayInvoice"
                      class="text-right tabstop"
                      type="text"
                      style="width:75px;"
                      ng-model="invoice.paymentAmount"                
                      fcsa-number="{
                        'maxDecimals': 2,
                        'addMissingDecimals': true,
                        'preventInvalidInput': true,
                        'prepend': '$',
                        'min': {{invoice.amount > 0 ? 0 : invoice.amount}}               
                      }"
                      ng-required="invoice.isSelected"
                      ng-change="toggleSelect(invoice, 'amount')"
                      ng-init="invoice.paymentAmount = (invoice.pendingtransaction.amount)"
                      /></span>
                    </h5>
                    <h5>Bank Account: <span>
                      <div class="btn-group accounts-btn" dropdown is-open="status.isopen" ng-if="customer.banks.length >= 1 && invoice.statusdescription !== 'Paid'">
                        <button type="button" class="btn btn-default dropdown-toggle" ng-disabled="customer.banks.length <= 1 || isInternalAccountAdminUser">
                          <div class = "account-info span3">                  
                            {{invoice.account}}
                          </div>
                        <span class="icon-arrow-down6 account-info"></span>
                        </button>
                        <div class="dropdown-menu">
                          <h5 ng-click="selectAccount(invoice, account)" ng-repeat="account in customer.banks">
                            {{account.name}}<br>
                            {{account.accountNumber}}
                          </h5>
                        </div>
                      </div></span>
                    </h5>
                  </div>
                </div>
              </div>
            </accordion-group>
          </accordion>
        </div>
      </div>
    </div>
  </div>

  <div ng-show="!invoiceCustomers.length" class="col-sm-7 no-results">
    <p>There are no invoices to display. Please try selecting another option in the dropdown.</p>
  </div>

  <div class="text-center" loading-spinner="loadingResults"></div>
 
  <div class="clearfix"></div>
</form>