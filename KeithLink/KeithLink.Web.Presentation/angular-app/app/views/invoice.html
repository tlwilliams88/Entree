<div page-header-bar>
  <div header-message>
    Showing:
      <div class="btn-group hidden-print" dropdown is-open="status.isopen1">
        <button type="button" class="btn-lg btn btn-default dropdown-toggle">{{selectedFilterView.name}} <span class="caret text-dark"></span></button>
        <ul class="dropdown-menu">
          <li><a
            ng-repeat="filterView in filterViews"
            ng-click="selectFilterView(filterView)"
            ng-if="selectedFilterView.name !== filterView.name">
          {{filterView.name}}</a></li>
        </ul>
      </div>
          <!-- Mobile Pay and Update buttons -->
    <button 
      type="button"
      ng-if="selectedFilterView.name !== 'Invoices Pending Payment'" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices && !isInternalUser" 
      class="btn-lg btn btn-primary pull-right-lg pull-right-md pull-right-sm pull-right-xs hidden-md hidden-lg hidden-print" 
      analytics-on 
      analytics-category="Invoices" 
      analytics-event="Pay Invoice"
      ng-show="hasPayableInvoices">
      Pay Now
    </button>
    <button       
      type="button"
      ng-if="selectedFilterView.name === 'Invoices Pending Payment'" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices && !isInternalUser" 
      class="btn-lg btn btn-primary pull-right hidden-md hidden-lg hidden-print">
      Update Payment(s)
    </button> 
   <span ng-if="!isMobile">Filter By: </span>
  
  <div ng-if="!isMobile" class="btn-group hidden-print hidden-sm">
    <form name="invoiceFilterForm" class="form-inline">
      <div dropdown is-open="openScope" style="float:left;">
        <button type="button" class="btn btn-lg btn-default dropdown-toggle">{{selectedInvoiceFilter}}<span class="caret margin-left-5" ></span></button>
        <ul class="dropdown-menu" role="menu">
          <li ng-repeat="invoiceFilter in invoiceFilters" >
            <a ng-click="selectInvoiceFilter(invoiceFilter.name)">
            {{invoiceFilter.name}}</a>
          </li>
        </ul>
        <input type="text" id="invoiceFilterInput" ng-model="invoiceFilter.input" class="form-control input-lg webFilterInput" placeholder="Search by {{selectedInvoiceFilter}}">
      </div>
      <span class="btn-group">
        <button class="btn-default btn btn-lg" type="submit" ng-disabled="!invoiceFilter.input" ng-click="filterInvoices(selectedInvoiceFilter, invoiceFilter.input)"><span class="icon-search large-icon hand"></span></button>
        <button class="btn-default btn btn-lg" type="button" ng-disabled="!invoiceFilter.input" ng-click="clearFilters(invoiceFilter.input);"><span class="icon-cross large-icon hand text-red"></span></button>
      </span> 
    </form>
   </div>
  </div>
  <div header-buttons>
    <button 
      type="button"
      ng-if="selectedFilterView.name !== 'Invoices Pending Payment'" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices && !isInternalUser" 
      class="btn-lg btn btn-primary pull-right-sm hidden-print" 
      analytics-on 
      analytics-category="Invoices" 
      analytics-event="Pay Invoice"
      ng-show="hasPayableInvoices">
      Pay Now
    </button>
    <button       
      type="button"
      ng-if="selectedFilterView.name === 'Invoices Pending Payment'" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices && !isInternalUser" 
      class="btn-lg btn btn-primary pull-right-sm hidden-print">
      Update Payment(s)
    </button>
    <a class="btn btn-icon btn-default" ng-click="print()" title="Print"><span class="icon-printer"></span></a>
    <a class="btn btn-icon btn-default" ng-click="openExportModal()" title="Export"><span class="icon-export"></span></a>
  </div>
</div>

<form name="invoiceForm"
      unsaved-warning-form 
      class="style-validation-errors" 
      novalidate>
  <div class="row">
    <div ng-if="(!isInternalAccountAdminUser || isDemo)">
      <div class="no-open-invoices" style="margin-left:15px;" ng-if="!hasPayableInvoices && !loadingResults">
        <p>You have no payable invoices at this time.</p>
        <p>Contact your DSR to pay invoices online.</p>
      </div>
      <div style="width:100%;" class="inline-block-display">
        <div class="pull-left billing-info" ng-if="hasPayableInvoices"></div>
      </div> 
    </div>
    <div class="col-sm-10" >
      <span class="pull-left"></span>
      <div class="text-red invoice-error">{{errorMessage}}</div>
    </div>

    <div class="invoiceoptions">
      <div class="row">
        <div class="col-sm-12 col-xs-8">
          <div class="hidden-print" ng-if="isMobile"> 
            <p>Filter By: </p>
            <div class="btn-group hidden-print" style="max-width:500px;">
              <form name="invoiceFilterForm">
                <div dropdown is-open="openScope" class="btn-group">
                  <button type="button" class="btn btn-default dropdown-toggle">{{selectedInvoiceFilter}}<span class="caret margin-left-5" ></span></button>
                  <ul class="dropdown-menu" role="menu">
                    <li ng-repeat="invoiceFilter in invoiceFilters" >
                    <a ng-click="selectInvoiceFilter(invoiceFilter.name)">
                    {{invoiceFilter.name}}</a></li>
                  </ul>
                </div>
                <input type="text" id="invoiceFilterInput" ng-model="invoiceFilter.input" class="form-control" placeholder="Search by {{selectedInvoiceFilter}}">
                <span class="btn-group">
                  <button class="btn-default btn" type="submit" ng-disabled="!invoiceFilter.input" ng-click="filterInvoices(selectedInvoiceFilter, invoiceFilter.input)"><span class="icon-search large-icon hand"></span></button>
                  <button class="btn-default btn" type="button" ng-disabled="!invoiceFilter.input" ng-click="clearFilters(invoiceFilter.input);"><span class="icon-cross large-icon hand text-red"></span></button>
                </span>
              </form>
            </div>
          </div>
          <div>
            <span ng-if="totalInvoices > 0" class="pull-left credit-memo-toggle">
              <input type="checkbox" ng-click="filterInvoices(invoiceFilter = !invoiceFilter)"> Invoices with Credit Memos
            </span>
            <span ng-if="totalInvoices > 0 && !isInternalUser" class="pull-left selectallinvoices credit-memo-toggle">
              <input type="checkbox" class="invoiceSelectAll" ng-model="invoices.allSelected" ng-click="toggleSelectedState(); selectAll('selectAllInvoices')"> Select All Invoices
            </span>
            <span ng-if="totalInvoices > 0 && !isInternalUser" class="total-amt total-line text-green currency-value pull-right-lg pull-right-md pull-right-sm pull-left-xs">Total: {{totalPaymentAmount() | currency}}</span>
            <span ng-if="totalInvoices > 0 && !isInternalUser">
              <a class="expandcollapsecustomers pull-right-lg pull-right-md pull-right-sm pull-left-xs">Expand/Collapse All Customers</a>
            </span>
<!--             <div ng-if="totalInvoices > 0" class="pull-right">
              <div class="input-group">
                <div class="input-group-btn">
                  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{selectedSortParameter}}<span class="caret"></span></button>
                    <ul class="dropdown-menu">
                      <li ng-repeat="sortParameter in sortParameters" >
                        <a ng-click="selectSortParameter(sortParameter.name, sortParameter.value)">{{sortParameter.name}}</a>
                      </li>
                    </ul>
                </div>
                <a style="margin-top:25px;" ng-click="sortInvoices('asc', sortParametervalue)">Asc </a><span>/</span><a ng-click="sortInvoices('desc', sortParametervalue)"> Desc</a>
              </div>
            </div> -->
          </div>
        </div>
      </div>

      <div class="row topPadded">
        <div class="col-sm-12">
          <accordion close-others="oneAtATime">
            <accordion-group ng-if="customer.invoices.results.length" is-open="status.openCategories" class="panel-title" ng-show="true" ng-repeat="customer in invoices | orderBy:'customerName'">
              <accordion-heading>
                <input type="checkbox" ng-if="!isInternalAccountAdminUser && customer.haspayableinvoices && selectedFilterView.name !== 'Paid Invoices'" ng-click="toggleSelectedState(); selectAll(selectCustomerInvoices, customer, $event)" ng-checked="customer.selected" class="pull-left"/>
                <div class="white-space: normal;">
                  <span style="padding-left:10px;"> {{customer.customerNumber}} - {{customer.customerName}} ({{customer.invoices.totalResults}})</span>
                  <span class="hidden-sm hidden-xs" style="margin-left:20px;"> {{customer.address.street}} {{customer.address.city}}, {{customer.address.regioncode}} {{customer.address.postalcode}}</span>
                  <i class="pull-right" ng-class="{'icon-arrow-up6': status.openCategories, 'icon-arrow-down7': !status.openCategories}"></i>
                </div>
              </accordion-heading>
              <div ng-repeat="invoice in customer.invoices.results" class="panel panel-body panel-default">
                <div>
                  <div>
                    <label>
                      <input type="checkbox" style="margin-left:10px;" no-dirty-check ng-if="invoice.userCanPayInvoice && !isInternalAccountAdminUser" ng-model="invoice.isSelected" ng-change="selectInvoice(invoice, invoice.isSelected)">
                    </label>
                  </div>
                  <div class="col-md-3 col-xs-6 row-fluid inline-block-display">
                    <span></span><a ng-click="linkToReferenceNumber(invoice.customerNumber, invoice.branchid, invoice.invoicenumber)"><strong><span style="text-decoration:none" class="text-black" ></span>{{::invoice.invoicenumber}}</a></strong>
                    <h5>{{::invoice.typedescription}}</h5>
                    <h5>Status: <span ng-class="{'highlight-text-late': (invoice.statusdescription == 'Past Due'), 'highlight-text-paid': (invoice.statusdescription == 'Paid') }" >{{::invoice.statusdescription}}</span></h5>
                  </div>
                  <div class="col-md-3 col-xs-6 row-fluid inline-block-display">
                    <h5 >PO Number: {{::invoice.ponumber}}</h5>
                    <h5 >Invoice Date: {{::invoice.invoicedate |formatDate}}</h5>
                    <h5 >Due Date: {{::invoice.duedate | formatDate}}</h5>
                  </div>
                  <div class="col-md-3 col-xs-6 row-fluid inline-block-display">
                    <h5 >Invoice Amount: {{::invoice.invoiceamount | currency}}</h5>
                    <h5>Amount Due: {{::invoice.amount | currency}}<span><a class="icon-plus3 large-icon margin-left-5" ng-if="invoice.transactioncount > 2" tooltip="View transaction history for this invoice."  ng-click="openTransactionSummaryModal(invoice)"></a></span></h5>
                    <h5>Invoice Image: <span><a ui-sref="invoiceimage({ invoiceNumber: invoice.invoicenumber })" target="_blank" class="icon-camera large-icon" analytics-on analytics-category="Invoices" analytics-event="View Invoice Image"></a></span></h5>
                  </div>
                  <div class="col-md-3 col-xs-6 row-fluid inline-block-display">
                    Scheduled Date: 
                    <a 
                      ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}" 
                      ng-if="invoice.userCanPayInvoice && !invoice.showDatePicker && !isInternalAccountAdminUser"
                      ng-mouseenter="invoice.showDatePicker=true"
                      class="icon-calendar large-icon text-right">
                    </a>
                    <a
                      id="datePickerWithOptions"
                      ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}"
                      ng-click="openDatepicker = true"
                      ng-if="invoice.userCanPayInvoice && invoice.showDatePicker && !isInternalAccountAdminUser"
                      class="icon-calendar large-icon text-right"                
                      datepicker-popup="{{datepickerOptions.options.dateFormat}}"
                      ng-model="invoice.date"
                      is-open="openDatepicker"
                      ng-change="toggleSelect(invoice, 'date'); validateBatch()"
                      min-date="datepickerOptions.minDate"
                      max-date="invoice.maxPaymentDate"
                      datepicker-options="datepickerOptions.options"
                      date-disabled="disabled(date, mode)"
                      close-text="Close">
                    </a>
                    <span style="margin-left:-10px;">
                    <span class="date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription !== 'Past Due' && invoice.statusdescription !== 'Payment Pending' && invoice.date">{{invoice.date | formatDate}}</span>
                    <span class="date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription === 'Past Due'">{{invoice.date || tomorrow | formatDate}}</span>
                    <span class="date-picker-field" ng-if="invoice.statusdescription === 'Payment Pending'">{{invoice.date || invoice.pendingtransaction.date | formatDate}}</span>
                    </span>
                    <h5>Payment Amount: <span ng-if="invoice.pendingtransaction && !invoice.pendingtransaction.editable">{{invoice.pendingtransaction.amount}}</span>
                    <span>
                      <input
                      remove-positive-numbers
                      ng-disabled="isInternalAccountAdminUser"
                      name="paymentAmount"
                      id="paymentAmount"
                      status = '{{invoice.statusdescription}}'
                      invoice-amount = "invoice.amount"
                      ng-if="invoice.userCanPayInvoice"
                      class="text-right tabstop"
                      type="text"
                      style="width:75px;"
                      ng-model="invoice.paymentAmount"                
                      fcsa-number="{
                        'maxDecimals': 2,
                        'addMissingDecimals': true,
                        'preventInvalidInput': true,
                        'prepend': '$',
                        'min': {{invoice.amount > 0 ? 0 : invoice.amount}}               
                      }"
                      ng-required="invoice.isSelected"
                      ng-change="toggleSelect(invoice, 'amount')"
                      ng-init="invoice.paymentAmount = (invoice.pendingtransaction.amount)"
                      /></span>
                    </h5>
                    <h5>Bank Account: <span>
                      <div class="btn-group accounts-btn" dropdown is-open="status.isopen" ng-if="invoice.banks.length >= 1 && invoice.statusdescription !== 'Paid'">
                        <button type="button" class="btn btn-default dropdown-toggle" ng-disabled="invoice.banks.length <= 1 || isInternalAccountAdminUser">
                          <div class = "account-info span3">                  
                            {{invoice.account}}
                          </div>
                        <span class="icon-arrow-down6 account-info"></span>
                        </button>
                        <div class="dropdown-menu">
                          <h5 ng-click="selectAccount(invoice, account)" ng-repeat="account in invoice.banks">
                            {{account.name}}<br>
                            {{account.accountNumber}}
                          </h5>
                        </div>
                      </div></span>
                    </h5>
                  </div>
                </div>
              </div>
            </accordion-group>
          </accordion>
        </div>
      </div>
    </div>
  </div>

  <div ng-show="!totalInvoices > 0 && !loadingResults" class="col-sm-7 no-results">
    <p>There are no invoices to display. Please try selecting another option in the dropdown.</p>
  </div>

  <div class="text-center" loading-spinner="loadingResults"></div>
 
  <div class="clearfix"></div>
</form>