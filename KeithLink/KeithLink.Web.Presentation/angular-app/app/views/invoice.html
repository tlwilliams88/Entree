<div page-header-bar>
  <div header-message>
    Showing
    <div class="btn-group hidden-print" dropdown is-open="status.isopen1">
      <button type="button" class="btn-lg btn btn-default dropdown-toggle">{{selectedFilterView.name}} <span class="caret text-dark"></span></button>

      <ul class="dropdown-menu">
        <li><a
          ng-repeat="filterView in filterViews"
          ng-click="selectFilterView(filterView)"
          ng-if="selectedFilterView.name !== filterView.name">
        {{filterView.name}}</a></li>
      </ul>
    </div>
<!--     <div class="btn-group hidden-print" dropdown is-open="status.isopen2">
    </div> -->
  </div>
  <div header-buttons>
    <button 
      type="button" 
      ng-disabled="invoiceForm.$invalid || getSelectedInvoices() <= 0 || errorMessage.length" 
      ng-click="payInvoices()" 
      ng-if="hasPayableInvoices" 
      class="btn btn-primary btn-lg pay-btn" 
      analytics-on 
      analytics-category="Invoices" 
      analytics-event="Pay Invoice"
      ng-show="hasPayableInvoices">
      <span ng-if="selectedFilterView.name !== 'Invoices Pending Payment'" >Pay Now</span>
      <span ng-if="selectedFilterView.name === 'Invoices Pending Payment'" >Update Payment(s)</span>
    </button>
    <a class="btn btn-icon btn-default" ng-click="print()" title="Print"><span class="icon-printer"></span></a>
    <a class="btn btn-icon btn-default" ng-click="openExportModal()" title="Export"><span class="icon-export"></span></a>
  </div>
</div>

  <form name="invoiceForm"
        unsaved-warning-form 
        class="style-validation-errors" 
        novalidate>

    <div class="row page-content" style="margin-top:5px;">
      <div  class = "billing" ng-if="(!isInternalAccountAdminUser || isDemo)">
      <div class="no-open-invoices" style="margin-left:15px;" ng-if="!hasPayableInvoices && !loadingResults">
        <p>You have no payable invoices at this time.</p>
        <p>Contact your DSR to pay invoices online.</p>
      </div>
      <div style=" width:100%; display:inline-block;">
      <div class="pull-left billing-info" ng-if="hasPayableInvoices">
      </div>
     </div> 
    </div>

       <div class="col-sm-10" >
          <span class="pull-left">
          </span>
          <div class="text-red invoice-error">{{errorMessage}}</div>
        </div>

<div style="max-width:100%; padding:0 50px 0 50px">
  <div class="row topPadded">
    <div class="col-sm-12 col-xs-8">
      <div class="pull-left credit-memo-toggle"><input type="checkbox" ng-click="filterInvoices(invoiceFilter = !invoiceFilter)" > Invoices with Credit Memos</div> 
      <div ng-if="!noInvoices" class="pull-left credit-memo-toggle" style="margin-left:15px;">
        <input type="checkbox" class="invoiceSelectAll" ng-model="invoiceCustomers.allSelected" ng-click="selectAll(areAllSelected = !areAllSelected, 'selectAllInvoices')"> Select All Invoices
      </div>
      <div ng-if="!noInvoices" class="pull-right">
        <a style="margin-right:10px;" class="expandcollapsecustomers">Expand/Collapse All Customers</a>
        <span class="total-amt total-line text-green currency-value">Total: {{totalPaymentAmount() | currency}}</span>
      </div>
    </div>
  </div>

  <div ng-if="!noInvoices" class="row topPadded">
    <div class="col-sm-12">
      <accordion close-others="oneAtATime">
        <accordion-group is-open="status.openCategories" class="panel-title" ng-show="true" ng-repeat="customer in invoiceCustomers | filter: {invoices: '!!'} | orderBy:'name'">
          <accordion-heading>
            <input type="checkbox" ng-if="!isInternalAccountAdminUser && customer.ispayable && selectedFilterView.name !== 'Paid Invoices'" ng-click="selectAll(areAllSelected = !areAllSelected, selectCustomerInvoices, customer, $event)" ng-checked="customer.selected" class="pull-left"/>
            <div class="white-space: normal;">
              <span style="padding-left:10px;"> {{customer.number}} - {{customer.name}} ({{customer.invoices.length}})</span>
              <span style="margin-left:20px;"> {{customer.street}} {{customer.city}}, {{customer.state}} {{customer.zipcode}}</span>
              <i class="pull-right" ng-class="{'icon-arrow-up6': status.openCategories, 'icon-arrow-down7': !status.openCategories}"></i>
            </div>
          </accordion-heading>
          <div ng-repeat="invoice in customer.invoices" class="panel panel-body panel-default">
            <div>
              <div>
                <label>
                  <input type="checkbox" style="margin-left:10px;" no-dirty-check ng-if="invoice.userCanPayInvoice && !isInternalAccountAdminUser" ng-model="invoice.isSelected" ng-change="selectInvoice(invoice, invoice.isSelected)">
                </label>
              </div>
              <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                <span></span><a class="span3" ng-click="linkToReferenceNumber(invoice.customernumber, invoice.branchid, invoice.invoicenumber)"><strong><span style="text-decoration:none" class="text-black" > Reference#:</span> {{invoice.invoicenumber}}</a></strong>
                <h5 class="span3">Type: {{invoice.typedescription}}</h5>
                <h5 class="span3">Status: {{invoice.statusdescription}}</h5>
              </div>
              <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                <h5 class="span3">PONumber: {{invoice.ponumber}}</h5>
                <h5 class="span3">Invoice Date: {{invoice.invoicedate |formatDate}}</h5>
                <h5 class="span3">Due Date: {{invoice.duedate | formatDate}}</h5>
              </div>
              <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                <h5 class="span3">Invoice Amount: {{invoice.invoiceamount | currency}}</h5>
                <h5>Amount Due: {{invoice.amount | currency}}<span><a class="icon-plus3 large-icon" style="margin-left:5px;" ng-if="invoice.transactioncount > 2" tooltip="View transaction history for this invoice."  ng-click="openTransactionSummaryModal(invoice)"></a></span></h5>
                <h5>Invoice Image: <span><a ui-sref="invoiceimage({ invoiceNumber: invoice.invoicenumber })" target="_blank" class="icon-camera large-icon" analytics-on analytics-category="Invoices" analytics-event="View Invoice Image"></a></span></h5>
              </div>
              <div style="display:inline-block;" class="col-md-3 col-xs-6 row-fluid">
                Scheduled Date: 
                <a 
                  ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}" 
                  ng-if="invoice.userCanPayInvoice && !invoice.showDatePicker && !isInternalAccountAdminUser"
                  ng-mouseenter="invoice.showDatePicker=true"
                  class="icon-calendar large-icon text-right span3">
                </a>
                <a
                  id="datePickerWithOptions"
                  ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)))}"
                  ng-click="openDatepicker = true"
                  ng-if="invoice.userCanPayInvoice && invoice.showDatePicker && !isInternalAccountAdminUser"
                  class="icon-calendar large-icon text-right span3"                
                  datepicker-popup="{{datepickerOptions.options.dateFormat}}"
                  ng-model="invoice.date"
                  is-open="openDatepicker"
                  ng-change="toggleSelect(invoice, 'date'); validateBatch()"
                  min-date="datepickerOptions.minDate"
                  max-date="invoice.maxPaymentDate"
                  datepicker-options="datepickerOptions.options"
                  date-disabled="disabled(date, mode)"
                  close-text="Close">
                </a>
                <span class="span3 date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription !== 'Past Due' && invoice.statusdescription !== 'Payment Pending' && invoice.date">{{invoice.date | formatDate}}</span>
                <span class="span3 date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription === 'Past Due'">{{invoice.date || tomorrow | formatDate}}</span>
                <span class="span3 date-picker-field" ng-if="invoice.statusdescription === 'Payment Pending'">{{invoice.date || invoice.pendingtransaction.date | formatDate}}</span>
                <h5 class="span3">Payment Amount: {{invoice.pendingtransaction.amount}} <span class="input-col">
                  <input
                  remove-positive-numbers
                  ng-disabled="isInternalAccountAdminUser"
                  name="paymentAmount"
                  id="paymentAmount"
                  status = '{{invoice.statusdescription}}'
                  invoice-amount = "invoice.amount"
                  ng-if="invoice.userCanPayInvoice"
                  class="span3 text-right tabstop"
                  type="text"
                  style="width:75px;"
                  ng-model="invoice.paymentAmount"                
                  fcsa-number="{
                    'maxDecimals': 2,
                    'addMissingDecimals': true,
                    'preventInvalidInput': true,
                    'prepend': '$',
                    'min': {{invoice.amount > 0 ? 0 : invoice.amount}}               
                  }"
                  ng-required="invoice.isSelected"
                  ng-change="toggleSelect(invoice, 'amount')"
                  ng-init="invoice.paymentAmount = (invoice.pendingtransaction.amount)"
                  /></span>
                </h5>

                <h5 class="span3">Bank Account: <span>
                  <div class=" span3 btn-group accounts-btn" dropdown is-open="status.isopen" ng-if="customer.banks.length >= 1 && invoice.statusdescription !== 'Paid'">
                    <button type="button" class="btn btn-default dropdown-toggle" ng-disabled="customer.banks.length <= 1 || isInternalAccountAdminUser">
                      <div class = "account-info span3">                  
                        {{invoice.account}}
                      </div>
                    <span class="icon-arrow-down6 account-info span3"></span>
                    </button>
                    <div class="dropdown-menu">
                      <h5 ng-click="selectAccount(invoice, account)" ng-repeat="account in customer.banks">
                        {{account.name}}<br>
                        {{account.accountNumber}}
                      </h5>
                    </div>
                  </div></span>
                </h5>
              </div>
            </div>
          </div>
        </accordion-group>
      </accordion>
    </div>
  </div>
</div>

<!--           <tr ng-repeat-start="invoice in invoices" ng-hide="invoiceFilter && !invoice.hascreditmemos" ng-class="{ odd : $odd, even: $even, 'item-selected': (invoice.isSelected && !errorMessage.length), 'invalid-item': invoice.failedBatchValidation, 'invoice__late':  invoice.status === 2}">
            <td ng-if="!viewingAllCustomers">
              <input no-dirty-check ng-if="invoice.userCanPayInvoice && !isInternalAccountAdminUser" type="checkbox" ng-model="invoice.isSelected" ng-change="selectInvoice(invoice, invoice.isSelected)">
            </td>
            <td ng-show="viewingAllCustomers">
              {{::invoice.customername}}
            </td>
            <td ng-show="viewingAllCustomers">
              {{::invoice.customernumber}}
            </td>
            <td>
              <a format="telephone=no" ng-show="invoice.typedescription === 'Invoice'" ng-click="linkToReferenceNumber(invoice.customernumber, invoice.branchid, invoice.invoicenumber)">{{::invoice.invoicenumber}}</a>
              <span ng-show="invoice.typedescription !== 'Invoice'">{{::invoice.invoicenumber}}</span>
            </td>
            <td class="hidden-mobile-visible-print">
              {{::invoice.typedescription}}
            </td>
            <td class="highlight-text hidden-mobile-visible-print">
              {{::invoice.statusdescription}}
            </td>
            <td class="highlight-text hidden-mobile-visible-print">
              {{::invoice.ponumber}}
            </td>
            <td class="hidden-mobile-visible-print">
              {{::invoice.invoicedate | formatDate}}
            </td>
            <td class="hidden-mobile-visible-print">
              {{::invoice.duedate | formatDate}}
            </td>
            <td >
              <div style="display:inline-block; white-space:nowrap;">
              <span class="pull-left" >{{::invoice.invoiceamount | currency}}</span>
             </div>
            </td>
            <td >
              <div style="display:inline-block; white-space:nowrap;">
              <span class="pull-left" >{{::invoice.amount | currency}}</span>
               <strong><a class="icon-plus3 large-icon" style="margin-left:5px;" ng-if="invoice.transactioncount > 2" tooltip="View transaction history for this invoice."  ng-click="openTransactionSummaryModal(invoice)"></a></strong>
             </div>
            </td>
            <td class="text-center icon-col large-icon hidden-mobile-visible-print">
            <a 
              ui-sref="invoiceimage({ invoiceNumber: invoice.invoicenumber })" 
              target="_blank" 
              class="icon-camera"  
              analytics-on
              analytics-category="Invoices" 
              analytics-event="View Invoice Image">
            </a>
            </td>
            <td ng-if="!viewingAllCustomers" class="hidden-mobile-visible-print datepicker">
            <a 
              ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)) || viewingAllCustomers)}"               
              ng-if="invoice.userCanPayInvoice && !invoice.showDatePicker && !isInternalAccountAdminUser"
              ng-mouseenter="invoice.showDatePicker=true"
              class="icon-calendar text-right" ng-hide="!invoice.date">
            </a>
            <a
                id="datePickerWithOptions"
                ng-class="{'hidden-icon' : ((invoice.statusdescription === 'Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)) || viewingAllCustomers)}"
                ng-click="openDatepicker = true"
                ng-if="invoice.userCanPayInvoice && invoice.showDatePicker && !isInternalAccountAdminUser"
                class="icon-calendar text-right"                
                datepicker-popup="{{datepickerOptions.options.dateFormat}}"
                ng-model="invoice.date"
                is-open="openDatepicker"
                ng-change="toggleSelect(invoice, 'date'); validateBatch()"
                min-date="datepickerOptions.minDate"
                max-date="invoice.maxPaymentDate"
                datepicker-options="datepickerOptions.options"
                date-disabled="disabled(date, mode)"
                close-text="Close">
            </a>
              <span class = "date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription !== 'Past Due' && invoice.statusdescription !== 'Payment Pending' && invoice.date">{{invoice.date | formatDate}}</span>
              <span class = "date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription === 'Past Due'">{{invoice.date || tomorrow | formatDate}}</span>
              <span class = "date-picker-field" ng-if="invoice.statusdescription === 'Payment Pending'">{{invoice.date || invoice.pendingtransaction.date | formatDate}}</span>
            </td>
            <td ng-if="!viewingAllCustomers" class="input-col">             
              <div style="width:75px; padding-right:6px; padding-top:8px;" class = "text-right" ng-if="invoice.pendingtransaction && !invoice.pendingtransaction.editable">{{invoice.pendingtransaction.amount}}</div>
              <input
                remove-positive-numbers
                ng-disabled="isInternalAccountAdminUser"
                name="paymentAmount"
                id="paymentAmount"
                status = '{{invoice.statusdescription}}'
                invoice-amount = "invoice.amount"
                ng-if="invoice.userCanPayInvoice"
                class="text-right tabstop"
                type="text"
                style="width:75px;"
                ng-model="invoice.paymentAmount"                
                fcsa-number="{
                  'maxDecimals': 2,
                  'addMissingDecimals': true,
                  'preventInvalidInput': true,
                  'prepend': '$',
                  'min': {{invoice.amount > 0 ? 0 : invoice.amount}}               
                }"
                ng-required="invoice.isSelected"
                ng-change="toggleSelect(invoice, 'amount')"
                ng-init="invoice.paymentAmount = (invoice.pendingtransaction.amount)"
                >
            </td>
            <td ng-if="!viewingAllCustomers" class="input-col hidden-mobile-visible-print" >
              <div class="btn-group accounts-btn" dropdown is-open="status.isopen" ng-if="accounts.length >= 1 && invoice.statusdescription !== 'Paid'">
               <button ng-init="defaultAccount(invoice);" type="button" class="btn btn-default dropdown-toggle" ng-disabled="accounts.length <= 1 || isInternalAccountAdminUser">
                  <div class = "account-info">                  
                    {{invoice.account}}
                  </div>
                  <span class="icon-arrow-down6"></span>
                </button>
                <div class="dropdown-menu">
                <table class="table no-margin">
                  <tr ng-click="selectAccount(invoice, account)" ng-repeat="account in accounts | orderBy: 'name'">
                       <td class="account-info">
                          {{account.name}}<br>
                          {{account.accountNumber}}
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
            </td>
            <td class="large-icon icon-col">             
              <a class="visible-xs visible-sm"><span class="hidden-print text-light icon-ellipsis" ng-click="showDetails = !showDetails;"></span></a>
            </td>
          </tr> -->

<!--           <tr ng-repeat-end class="mobile-details-row hidden-md hidden-lg" ng-show="showDetails" ng-class="{ odd : $odd, even: $even }">
            <td colspan="6">
              <table>
                <colgroup>
                  <col width="25%" />
                  <col width="75%" />
                </colgroup>
                <tr>
                  <td>Invoice Date</td>
                  <td>{{::invoice.invoicedate | formatDate}}</td>
                </tr>
                <tr>
                  <td>Due Date</td>
                  <td>{{::invoice.duedate | formatDate}}</td>
                </tr>
                <tr>
                  <td>Status</td>
                  <td>{{::invoice.statusdescription}}</td>
                </tr>
                <tr>
                  <td>Type</td>
                  <td>{{::invoice.typedescription}}</td>
                </tr> -->
                <!-- <tr ng-if="invoice.userCanPayInvoice">
                  <td>Payment Amount</td>
                  <td>
                    <input
                      name="paymentAmount"
                      id="paymentAmount"
                      ng-if="invoice.userCanPayInvoice"
                      class="form-control text-right"
                      type="text"
                      ng-model="invoice.paymentAmount"
                      fcsa-number="{
                        'maxDecimals': 2,
                        'addMissingDecimals': true,
                        'preventInvalidInput': true,
                        'prepend': '$',
                        'min': {{invoice.amount > 0 ? 0 : invoice.amount}}
                      }"
                      ng-required="invoice.isSelected"
                      ng-change="toggleSelect(invoice)"
                      >
                  </td>
                </tr> -->
<!--                 <tr ng-if="!viewingAllCustomers">
                  <td>
                    Schedule<br>
                    Date
                  </td>
                  <td class="datepicker">
                  <a
                    ng-click="openDatepicker = true"              
                    ng-if="invoice.userCanPayInvoice && !isInternalAccountAdminUser && !(invoice.statusdescription ==='Past Due' && (invoice.amount > 0 || currDate > invoice.maxPaymentDate)) && !viewingAllCustomers"       class="icon-calendar text-right"                
                    datepicker-popup="{{datepickerOptions.options.dateFormat}}"
                    ng-model="invoice.date"
                    ng-change="toggleSelect(invoice, 'date'); validateBatch()"
                    is-open="openDatepicker"
                    min-date="datepickerOptions.minDate"
                    max-date="invoice.maxPaymentDate"
                    datepicker-options="datepickerOptions.options"
                    date-disabled="disabled(date, mode)"
                    close-text="Close"></a>
                 
              <span class = "date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription !== 'Past Due' && invoice.statusdescription !== 'Payment Pending' && invoice.date">{{invoice.date | formatDate}}</span>
              <span class = "date-picker-field" ng-if="invoice.userCanPayInvoice && invoice.statusdescription === 'Past Due'">{{invoice.date || tomorrow | formatDate}}</span>
              <span class = "date-picker-field" ng-if="invoice.statusdescription === 'Payment Pending'">{{invoice.date || invoice.pendingtransaction.date | formatDate}}</span>             
                 </td>
               </tr>
                <tr ng-if="!viewingAllCustomers && accounts.length">
                  <td ng-if="accounts.length >= 1 && invoice.statusdescription !== 'Paid'">
                    Bank Account
                  </td>            
                  <td>
                    <div class="btn-group accounts-btn" dropdown is-open="status.isopen" ng-if="accounts.length >= 1 && invoice.statusdescription !== 'Paid'">
                      <button type="button" ng-init="defaultAccount(invoice);" class="btn btn-default dropdown-toggle" ng-disabled="accounts.length <= 1 || isInternalAccountAdminUser">
                        <div class = "account-info">                  
                          {{invoice.account}}
                        </div>
                      <span class="icon-arrow-down6 account-info"></span>
                      </button>
                      <div class="dropdown-menu">
                         <table class="table no-margin">
                          <tr ng-click="selectAccount(invoice, account)" ng-repeat="account in accounts | orderBy: 'name'">
                            <td class = "account-info">
                          {{account.name}}<br>
                          {{account.accountNumber}}
                        </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </td>  
                </tr>
                <tr>
                  <td class="large-icon" colspan="2">
                    <a 
                      ng-if="invoice.invoicelink" 
                      ui-sref="invoiceimage({ invoiceNumber: invoice.invoicenumber })" 
                      class="icon-camera"
                      analytics-on
                      analytics-category="Invoices" 
                      analytics-event="View Invoice Image">
                    </a>
                   </td>
                </tr>
              </table>
            </td>
          </tr> -->

<!--         </tbody>

        <tfoot ng-show="invoices.length === 0 && !loadingResults">
          <tr>
            <td colspan="14">There are no invoices to display.</td>
          </tr>
        </tfoot>
      </table>
      </div> -->

      <div class="text-center" loading-spinner="loadingResults"></div>

      <div ng-show="noInvoices" class="col-sm-12">
        <p>There are no invoices to display.</p>
      </div>
   
    <div class="clearfix"></div>
  </form>
</div>

